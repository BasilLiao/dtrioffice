<div class="row border" id="sys_user_body">
	<div class="col-md-12 border">
		<!-- 功能: 查詢 /新增 /修改 -->
		<div class="mt-3 mb-3 border">
			<div class="mb-3">
				<h3>
					<b>帳號功能</b>
				</h3>
			</div>
			<!-- 查詢功能 -->
			<div class="mb-3 border border-primary shadow bg-light">
				<div class="row mb-2">
					<div class="col-md-5">
						<a class="btn btn-sm btn-success" data-toggle="collapse" href="#collapseSearch" role="button" aria-expanded="true" aria-controls="collapseSearch"> 查詢功能 : </a>
					</div>
				</div>
				<div class="mb-3 collapse show" id="collapseSearch">
					<div class="col-md-12 mb-5">
						<div class="row">
							<div class="row">
								<div class="col-md-12 text-left">
									項目: <select class="md-12 a_row2" id="s_item" name="s_item">
										<option value="account">帳號</option>
										<option value="email">Email</option>
										<option value="name">名稱</option>
									</select> <input class="col-md-7" type="text" id="s_name" name="s_name" placeholder="Ex:user" required autofocus />
								</div>
							</div>
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										職位 : <input class="col-md-7" type="text" id="s_position" name="s_position" placeholder="Ex:董事長" required />
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row mb-2">
						<div class="col-md-5"></div>
						<div class="col-md-2">
							<button id="s_submit" class="col-md-12 btn btn-primary btn-block" type="submit">查詢</button>
						</div>
						<div class="col-md-5"></div>
					</div>
				</div>
			</div>
			<!-- 功能:查詢結果  /修改 -->
			<div class="mb-3 border border-primary shadow bg-light">
				<div class="border">
					<div class="row mb-2">
						<div class="col-md-5">
							<a class="btn btn-sm btn-success" data-toggle="collapse" href="#collapseFinish" role="button" aria-expanded="true" aria-controls="collapseFinish"> 查詢結果 : </a>
						</div>
					</div>
					<div class="collapse show" id="collapseFinish">
						<div class="col-md-12">
							<div id="search_choose" class="row mb-2">
								<div class="text-left">
									<b>顯示名稱-></b>
								</div>
							</div>
							<!-- 顯示內容 -->
							<div class="row">
								<table style="min-height: 480px;" class="table table-sm table-hover table-striped table-bordered table-responsive">
									<thead>
										<tr id="search_thead" class="bg-primary">
											<th scope="col" style="min-width: 90px;">功能</th>
											<th scope="col" style="min-width: 40px;">筆</th>
										</tr>
									</thead>
									<tbody id="search_tbody"></tbody>
								</table>
							</div>
							<div aria-label="Page">
								<ul class="pagination justify-content-center">
									<li class="page-item p_p disabled"><a id="p_p" class="page-link" href="#" onclick="return templateBody.change_page(this);">Previous 10 </a></li>
									<li class="page-item p_nb p1 active"><a id="p1" class="page-link" href="#" onclick="return templateBody.change_page(this);">1</a></li>
									<li class="page-item p_nb p2"><a id="p2" class="page-link" href="#" onclick="return templateBody.change_page(this);">2</a></li>
									<li class="page-item p_nb p3"><a id="p3" class="page-link" href="#" onclick="return templateBody.change_page(this);">3</a></li>
									<li class="page-item p_nb p4"><a id="p4" class="page-link" href="#" onclick="return templateBody.change_page(this);">4</a></li>
									<li class="page-item p_nb p5"><a id="p5" class="page-link" href="#" onclick="return templateBody.change_page(this);">5</a></li>
									<li class="page-item p_nb p6"><a id="p6" class="page-link" href="#" onclick="return templateBody.change_page(this);">6</a></li>
									<li class="page-item p_nb p7"><a id="p7" class="page-link" href="#" onclick="return templateBody.change_page(this);">7</a></li>
									<li class="page-item p_nb p8"><a id="p8" class="page-link" href="#" onclick="return templateBody.change_page(this);">8</a></li>
									<li class="page-item p_nb p9"><a id="p9" class="page-link" href="#" onclick="return templateBody.change_page(this);">9</a></li>
									<li class="page-item p_nb p10"><a id="p10" class="page-link" href="#" onclick="return templateBody.change_page(this);">10</a></li>
									<li class="page-item p_n disabled"><a id="p_n" class="page-link" href="#" onclick="return templateBody.change_page(this);">Next 10 </a></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 新增/修改功能 -->
			<div class="border border-primary shadow bg-light">
				<div class="row mb-2">
					<div class="col-md-5">
						<a class="btn btn-sm btn-success" data-toggle="collapse" href="#collapseAdded" role="button" aria-expanded="true" aria-controls="collapseAdded"> 新增/修改/刪除 功能 : </a>
					</div>
				</div>
				<form onsubmit="return templateBody.send_added_or_update_save();">
					<div class="collapse show" id="collapseAdded">
						<!-- 新增 或 修改(分辨) -->
						<div class="row mb-1">
							<div class="col-md-2">
								<div class="text-left">
									<div class="col-md-12">狀態 :</div>
									<div class="col-md-12" id="a_u_type" style="font-size: 25px; color: red;">新增資料</div>
								</div>
							</div>
							<div class="col-md-2">
								<div class="row text-left">
									<div class="col-md-6 pr-0">UserID:</div>
									<div class="col-md-6 pl-0" id="a_u_id">0</div>
								</div>
							</div>
							<div class="col-md-2">
								<div class="row text-left">
									<div class="col-md-6 pr-0">GroupID:</div>
									<div class="col-md-6 pl-0" id="a_u_group_id">0</div>
								</div>
							</div>
							<div class="col-md-2">
								<div class="row text-left">
									<div class="col-md-8 pr-0">GroupName:</div>
									<div class="col-md-4 pl-0 pr-0" id="a_u_group_name">
										<select class="" required></select>
									</div>
								</div>
							</div>
						</div>
						<div class="dropdown-divider" style="border-top: 1px solid green;"></div>
						<!-- 新增 或 修改 或 刪除(內容) -->
						<div class="row mb-3 mt-3">
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										個人名稱 : <input class="col-md-7" type="text" id="a_name" name="a_name" placeholder="Ex:小王" required />
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										英文名稱 : <input class="col-md-7" type="text" id="a_e_name" name="a_e_name" placeholder="Ex:Mickey Mouse" required />
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										職位 : <input class="col-md-7" type="text" id="a_position" name="a_position" placeholder="Ex:董事長" required />
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										帳號 : <input class="col-md-7" type="text" id="a_account" name="a_account" placeholder="Ex:帳號設定" required />
									</div>
								</div>
							</div>

						</div>
						<div class="row mb-5">
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										說明備註 : <input class="col-md-7" type="text" id="a_note" name="a_note" placeholder="Ex:可不寫" />
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										狀態 : <input class="col-md-7" type="text" id="a_useful" name="a_useful" placeholder="2=開 1=關" required />
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										Email : <input class="col-md-9" type="email" id="a_email" name="a_email" placeholder="Ex:apple@dtri.com" required />
									</div>
								</div>
							</div>
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12 text-left">
										密碼 : <input class="col-md-7" type="password" id="a_password" name="a_password" placeholder="Ex:0%^&sr" required />
									</div>
								</div>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-4"></div>
							<div class="col-md-2">
								<div class="">
									<button id="a_u_submit" class="btn btn-primary btn-block" type="submit">存入資料</button>
								</div>
							</div>
							<div class="col-md-2">
								<div class="">
									<button id="a_c_submit" class="btn btn-warning btn-block" type="button">清除內容</button>
								</div>
							</div>
							<div class="col-md-4"></div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	console.log("sys_user_body");
	templateBody = new Vue({
		el : "#sys_user_body",
		data : {
			l_search_thead : "",
			search_list : "",
			search_group : "",
			//分頁功能
			page_max : 100,//當前本批 筆數
			page_max_total : 100,//最大總數
			page_batch : 0,//第幾批
			page_batch_total : 100,//每批間格值
			page_every : 10,//當前每頁筆數
			page_stay : 1,//當前頁數
			s_4 : 0,//當前產品ID
			d_1 : '',//當前的 投線日
			d_2 : '',//當前的 出貨日
		},
		created : function() {
			//初始化
			console.log(main.contentData.templateInfo.body["list"]);
			this.search_group = main.contentData.templateInfo.body["grouplist"];
			this.search_list = main.contentData.templateInfo.body["list"];
			//t_choose
			var min_width = 100;
			for (var i = 0; i < this.search_list[0].length; i++) {
				var choose_check = '[<div class="text-left form-check">';
				choose_check += '<input class="form-check-input" type="checkbox" value="" id="s_' + i + '" checked>';
				choose_check += '<label class="form-check-label" for="s_' + i + '">' + this.search_list[0][i] + "</label>";
				choose_check += "</div>]";
				$("#search_choose").append(choose_check);
			}
			//t_header
			for (var i = 0; i < this.search_list[0].length; i++) {
				if (i == 0 || i == 2 || i == 11) {
					min_width = 180;
				}
				$("#search_thead").append('<th style="min-width: ' + min_width + 'px;" class="s_' + i + '" scope="col">' + this.search_list[0][i] + "</th>");
				min_width = 100;
			}
			//t_body
			this.search_update();
			//t_body_group
			this.group_choose();

			//動態監聽顯示Table 物件 查看開關
			$(document).on("click", "#search_choose input", function(event) {
				templateBody.search_choose(event);
			});
			//查詢監聽
			$(document).on("click", "#s_submit", function(event) {
				//頁數-重製分頁
				templateBody.change_page_init();
				templateBody.send_search();
			});
			//清除修改
			$(document).on("click", "#a_c_submit", function(event) {
				templateBody.rm_added();
			});
		},
		methods : {
			search_choose : function(event) {
				console.log(event.target.checked);
				if (!event.target.checked) {
					$("#search_thead ." + event.target.id).hide();
					$("#search_tbody ." + event.target.id).hide();
				} else {
					$("#search_thead ." + event.target.id).show();
					$("#search_tbody ." + event.target.id).show();
				}
			},
			//查詢更新
			search_update : function() {
				$("#search_tbody").empty();
				//頁數-刷新
				this.change_page_update();
				//t_body
				for (var i = 1; i < this.search_list.length; i++) {
					//頁數-每頁顯示(不再顯示範圍內則隱藏)
					var page_group = this.change_page_btn(i);
					//功能
					var s_list = this.search_list[i][4];

					var a_submit = '<div class="md-6">';
					a_submit += '<button user_id="' + s_list + '" class="btn btn-warning btn-sm btn-block a_submit">';
					a_submit += "改</button></div>";

					var d_submit = '<div class="md-6 ml-1">';
					d_submit += '<button user_id="' + s_list + '" class="btn btn-danger btn-sm btn-block d_submit">';
					d_submit += "刪</button></div>";

					$("#search_tbody").append('<tr class="page_all t_row' + s_list + ' '+page_group+'"><th class="ml-0 col-md-12 row">' + a_submit + d_submit + "</th></tr>");
					//計數量
					$("#search_tbody .t_row" + this.search_list[i][4]).append("<td >" + i + "</td>");

					for (var j = 0; j < this.search_list[i].length; j++) {
						$("#search_tbody .t_row" + s_list).append("<td class=s_" + j + ">" + this.search_list[i][j] + "</td>");
					}
				}
				//修改監聽
				$(document).on("click", ".a_submit", function(event) {
					templateBody.choose_update("修改資料", event);
				});
				//刪除監聽
				$(document).on("click", ".d_submit", function(event) {
					templateBody.choose_delete(event);
				});
			},
			//選擇群組-並建立監聽
			group_choose : function() {
				var group = "";
				$("#a_u_group_name select").empty();
				group += '<option value="">請選擇</option>';
				$.each(this.search_group, function(index, val) {
					group += "<option value=" + val + ">" + index + "</option>";
				});
				$("#a_u_group_name select").append(group);

				$(document).on("change", "#a_u_group_name select", function(event) {
					$("#a_u_group_id").text(event.target.value);
				});
			},
			//清除新增/修該內容
			rm_added : function() {
				$("#a_u_type").text("新增資料");
				$("#a_u_id").text("0");
				$("#a_u_group_id").text("0");
				$("#a_u_group_name select").val("");

				$("#a_name").val("");
				$("#a_e_name").val("");
				$("#a_account").val("");
				$("#a_position").val("");
				$("#a_password").val("");

				$("#a_email").val("");
				$("#a_useful").val("");
				$("#a_note").val("");

				this.choose_disabled(false);
			},
			//選擇  修改
			choose_update : function(a_u_type, event) {
				var id = event.target.attributes.user_id.value;
				$("#a_name").val($(".t_row" + id + " .s_5")[0].innerText);
				$("#a_e_name").val($(".t_row" + id + " .s_6")[0].innerText);

				$("#a_account").val($(".t_row" + id + " .s_7")[0].innerText);
				$("#a_position").val($(".t_row" + id + " .s_8")[0].innerText);
				$("#a_password").val("");
				$("#a_email").val($(".t_row" + id + " .s_9")[0].innerText);
				$("#a_useful").val($(".t_row" + id + " .s_12")[0].innerText);
				$("#a_note").val($(".t_row" + id + " .s_13")[0].innerText);

				$("#a_u_type").text(a_u_type);
				$("#a_u_id").text($(".t_row" + id + " .s_4")[0].innerText);
				$("#a_u_group_id").text($(".t_row" + id + " .s_10")[0].innerText);
				$("#a_u_group_name select").val($(".t_row" + id + " .s_10")[0].innerText);

				// a_u_group_name
				this.choose_disabled(false);
			},
			//選擇 刪除
			choose_delete : function(event) {
				var id = event.target.attributes.user_id.value;
				var a_u_type = "移除資料";
				$("#a_u_type").text(a_u_type);
				$("#a_u_id").text($(".t_row" + id + " .s_4")[0].innerText);
				$("#a_u_group").text($(".t_row" + id + " .s_6")[0].innerText);

				this.choose_update(a_u_type, event);
				this.choose_disabled("disabled");
			},
			//鎖定資料
			choose_disabled : function(disabled) {
				$("#a_name").attr("disabled", disabled);
				$("#a_e_name").attr("disabled", disabled);
				$("#a_account").attr("disabled", disabled);
				$("#a_position").attr("disabled", disabled);
				$("#a_password").attr("disabled", disabled);
				$("#a_email").attr("disabled", disabled);
				$("#a_useful").attr("disabled", disabled);
				$("#a_note").attr("disabled", disabled);

				$("#a_u_group_name select").attr("disabled", disabled);
			},
			//傳送 新增 or 修改 or 刪除
			send_added_or_update_save : function() {
				var content = new Object();

				content.name = $("#a_name").val();
				content.e_name = $("#a_e_name").val();
				content.position = $("#a_position").val();
				content.account = $("#a_account").val();
				content.password = $("#a_password").val();
				content.email = $("#a_email").val();
				content.useful = $("#a_useful").val();
				content.note = $("#a_note").val();
				content.id = $("#a_u_id").text();
				content.group_id = $("#a_u_group_id").text();
				content.group_name = $("#a_u_group_name select:selected").text();

				var action = "C";
				var url = "./added_sys_user.do";
				var order = "search_update"; //指令
				if ($("#a_u_type").text() == "修改資料") {
					action = "U";
					url = "./update_sys_user.do";
				}
				if ($("#a_u_type").text() == "移除資料") {
					action = "D";
					url = "./delete_sys_user.do";
				}

				var data = JSON.stringify({
					data : {
						datetime : "",
						action : action,
						whoami : main.loginData.account,
						cellBackName : "bodyAfter",
						cellBackOrder : order,
						content : content,
					},
				});
				main.ajaxSend(url, data);
				return false; //防止真傳送
			},
			//頁數-初始化(新增 or 修改 or 刪除 or 條件 要重製)
			change_page_init : function() {
				//active 更換為第一格
				var a = "active";
				var d = "disabled";
				$(".page-item").removeClass(a);
				$(".page-item").removeClass(d);
				for (var re_page = 1; re_page <= 10; re_page++) {
					var now_page = re_page + (this.page_batch * 10);
					//如果就在第一頁 不需更換
					if (!$(".p" + now_page).hasClass("p" + re_page)) {
						$(".p" + now_page).addClass("p" + re_page);
						$(".p" + re_page).removeClass("p" + now_page);
						$(".p" + re_page + " a").text(re_page);
						$(".p" + re_page + " a").attr("id", "p" + re_page);
					}
					if (re_page == 1) {
						$(".p" + now_page).addClass(a);
					}
				}
				//分頁功能
				this.page_max = 100;//當前本批 筆數
				this.page_max_total = 100;//最大總數
				this.page_batch = 0;//第幾批
				this.page_batch_total = 100;//每批間格值
				this.page_every = 10;//當前每頁筆數
				this.page_stay = 1;//當前頁數

			},
			//頁數-刷新
			change_page_update : function() {
				//頁數-取得當前最大筆數 && 頁數
				this.page_max = this.search_list.length;
				$(".p_n").removeClass("disabled");
				if (this.page_max < this.page_max_total) {
					$(".p_n").addClass("disabled");
				}
				$(".p_p").removeClass("disabled");
				if (this.page_batch < 1) {
					$(".p_p").addClass("disabled");
				}
				//頁數-隱藏多於頁數
				$(".p_nb").addClass("disabled");

			},
			//頁數-換頁按鈕建置(頁數-每頁顯示)
			change_page_btn : function(i) {
				var d_none = "";
				if (i > (this.page_every * this.page_stay)) {
					d_none = "d-none";
				}
				//頁數-(個位數)+(十位數)
				var page_group = "pg_" + (Math.floor((i - 1) / this.page_every) + 1 + (this.page_batch * 10));
				var page_nb = "p" + (Math.floor((i - 1) / this.page_every) + 1 + (this.page_batch * 10));
				$("." + page_nb).removeClass("disabled");
				return page_group + " " + d_none;
			},
			//頁數-換頁查詢
			change_page : function(event) {
				var d = "disabled";
				var d_n = "d-none";
				var a = "active";
				var pg = "pg_";
				console.log("page btn is:" + event.text);
				//選定頁數
				if (event.id != "p_p" && event.id != "p_n") {
					$(".page-item").removeClass(a);
					$("." + event.id).addClass(a);

					$(".page_all").addClass(d_n);
					$("." + pg + event.text).removeClass(d_n);

				} else if (event.id == "p_p") {//上10頁(批數 要大於1)
					if (this.page_batch > 0) {
						//換上一批次 頁數
						$(".page-item").removeClass(a);

						for (var i = 1; i <= 10; i++) {
							var now_page = i + (this.page_batch * 10);
							var previous_page = i + ((this.page_batch) * 10) - 10;
							$(".p" + now_page).addClass("p" + previous_page);
							$(".p" + previous_page).removeClass("p" + now_page);
							$(".p" + previous_page + " a").text(previous_page);
							$(".p" + previous_page + " a").attr("id", "p" + previous_page);
							if (i == 1) {
								$(".p" + previous_page).addClass(a);
							}
						}
						this.page_batch -= 1;
						this.send_search("");
					}
				} else if (event.id == "p_n") {//下10頁(必須滿100筆最大量 )
					if (this.page_max >= this.page_max_total) {
						//換下一批次 頁數
						$(".page-item").removeClass(a);
						for (var i = 1; i <= 10; i++) {
							var now_page = i + (this.page_batch * 10);
							var next_page = i + ((this.page_batch + 1) * 10);
							$(".p" + now_page).addClass("p" + next_page);
							$(".p" + next_page).removeClass("p" + now_page);
							$(".p" + next_page + " a").text(next_page);
							$(".p" + next_page + " a").attr("id", "p" + next_page);
							if (i == 1) {
								$(".p" + next_page).addClass(a);
							}
						}
						this.page_batch += 1;
						this.send_search("");
					}
				}
				return false;
			},
			//傳送 查詢
			send_search : function() {
				var content = new Object();

				switch ($("#s_item").val()) {
				case "account":
					content.account = $("#s_name").val();
					break;
				case "email":
					content.email = $("#s_name").val();
					break;
				case "name":
					content.name = $("#s_name").val();
					break;
				default:
					break;
				}

				content.position = $("#s_position").val();
				//content.name = $("#s_name").val();

				var url = "./sys_user.do";
				var order = "search_update"; //指令

				var data = JSON.stringify({
					data : {
						datetime : "",
						action : "R",
						whoami : main.loginData.account,
						cellBackName : "bodyAfter",
						cellBackOrder : order,
						content : content,
					},
				});
				main.ajaxSend(url, data);
			},
			//Rsp-回傳值-指令
			bodyAfter : function(event) {
				console.log("to index success");
				switch (event.r_cellBackOrder) {
				case "search_update":
					//刷新資料
					if (event.r_content.templateInfo.body["list"] != null && event.r_content.templateInfo.body["list"] != "") {
						this.search_list = event.r_content.templateInfo.body["list"];
						this.search_update();
						this.rm_added();
					}
					break;
				case "update_body_nav":
					break;
				}
			},
		},
		//移除監聽事件
		beforeDestroy : function() {
			console.log("to beforeDestroy event");
			$(document).off("click", "#a_u_group_name select");
			$(document).off("click", "#search_choose input");
			$(document).off("click", "#s_submit");
			$(document).off("click", "#a_c_submit");
			$(document).off("click", ".a_submit");
			$(document).off("click", ".d_submit");
		},
	});
</script>
