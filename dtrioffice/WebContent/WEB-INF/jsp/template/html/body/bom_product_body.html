<div class="row border" id="bom_product_body">
	<div class="col-md-12 border">
		<!-- 功能: 查詢 /新增 /修改 -->
		<div class="mt-3 mb-3 border">
			<div class="mb-3">
				<h3>
					<b>建立 產品BOM規格 功能</b>
				</h3>
			</div>
			<!-- 查詢功能 -->
			<div class="mb-3 border border-primary shadow bg-light">
				<div class="row mb-2 m-0">
					<div class="col-md-5 p-0">
						<a class="btn btn-sm btn-success" data-toggle="collapse" href="#collapseSearch" role="button" aria-expanded="true" aria-controls="collapseSearch"> 查詢功能 : </a>
					</div>
				</div>
				<div class="h5 collapse show" id="collapseSearch">
					<div class="col-md-12">
						<div class="row">
							<div class="col-md-6 border border-primary">
								<div class="text-left mb-2 mt-2 row m-0">
									<div class="col-3 p-0">項目群組:</div>
									<select class="col-3 a_row2" id="s_g_item" name="s_g_item">
										<option value="">請選擇</option>
									</select>
								</div>
								<div class="text-left mb-2 mt-2 row m-0">
									<div class="col-3 p-0">支項項目:</div>
									<select class="col-3 a_row2" id="s_i_item" name="s_i_item">
										<option value="">請選擇</option>
									</select>
								</div>
								<div class="text-left mb-2 mt-2 row m-0">
									<div class="col-3 p-0">產品型號:</div>
									<input class="col-7" type="text" id="s_model" name="s_model" placeholder="Ex:型號123456" required autofocus />
								</div>
								<div class="text-left mb-2 mt-2 row m-0">
									<div class="col-3 p-0">BOM料號:</div>
									<input class="col-7" type="text" id="s_bom_number" name="s_bom_number" placeholder="Ex:A513-8745940-123" required autofocus />
								</div>
								<div class="row mb-2 mt-2 m-0 p-1">
									<div class="col-md-4">
										<button id="s_l_submit" class="col-md-12 btn btn-info btn-block m-1" type="submit">Step1.條件登記</button>
									</div>
									<div class="col-md-4">
										<button id="s_submit" class="col-md-12 btn btn-primary btn-block m-1" type="submit">Step2.查詢條件</button>
									</div>
									<div class="col-md-4">
										<button id="s_c_submit" class="col-md-12 btn btn-warning btn-block m-1" type="button">清除條件</button>
									</div>
								</div>
							</div>
							<div class="col-md-6 border border-primary">
								<div class="" id="s_l_list">
									<div class="text-left mb-2 mt-2">條件清單:</div>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 功能:查詢結果  /修改 -->
			<div class="mb-3 border border-primary shadow bg-light">
				<div class="border">
					<div class="row mb-2 m-0">
						<div class="col-md-5 p-0">
							<a class="btn btn-sm btn-success" data-toggle="collapse" href="#collapseFinish" role="button" aria-expanded="true" aria-controls="collapseFinish"> 查詢結果 : </a>
						</div>
					</div>
					<div class="collapse show" id="collapseFinish">
						<div class="col-md-12">
							<div id="search_choose" class="row mb-2">
								<div class="text-left">
									<b>顯示名稱-></b>
								</div>
							</div>
							<!-- 顯示內容 -->
							<div class="row">
								<table style="min-height: 480px;" class="table table-sm table-hover table-striped table-bordered table-responsive">
									<thead>
										<tr id="search_thead" class="h5 bg-primary">
											<th scope="col" style="min-width: 135px;">功能</th>
											<th scope="col" style="min-width: 40px;">筆</th>
										</tr>
									</thead>
									<tbody id="search_tbody"></tbody>
								</table>
							</div>
							<div id="page-items" aria-label="Page">
								<ul class="pagination justify-content-center">
									<li class="page-item p_p disabled"><a id="p_p" class="page-link" href="#" onclick="return templateBody.change_page(this);">Previous 10 </a></li>
									<li class="page-item p_nb p1 active"><a id="p1" class="page-link" href="#" onclick="return templateBody.change_page(this);">1</a></li>
									<li class="page-item p_nb p2"><a id="p2" class="page-link" href="#" onclick="return templateBody.change_page(this);">2</a></li>
									<li class="page-item p_nb p3"><a id="p3" class="page-link" href="#" onclick="return templateBody.change_page(this);">3</a></li>
									<li class="page-item p_nb p4"><a id="p4" class="page-link" href="#" onclick="return templateBody.change_page(this);">4</a></li>
									<li class="page-item p_nb p5"><a id="p5" class="page-link" href="#" onclick="return templateBody.change_page(this);">5</a></li>
									<li class="page-item p_nb p6"><a id="p6" class="page-link" href="#" onclick="return templateBody.change_page(this);">6</a></li>
									<li class="page-item p_nb p7"><a id="p7" class="page-link" href="#" onclick="return templateBody.change_page(this);">7</a></li>
									<li class="page-item p_nb p8"><a id="p8" class="page-link" href="#" onclick="return templateBody.change_page(this);">8</a></li>
									<li class="page-item p_nb p9"><a id="p9" class="page-link" href="#" onclick="return templateBody.change_page(this);">9</a></li>
									<li class="page-item p_nb p10"><a id="p10" class="page-link" href="#" onclick="return templateBody.change_page(this);">10</a></li>
									<li class="page-item p_n disabled"><a id="p_n" class="page-link" href="#" onclick="return templateBody.change_page(this);">Next 10 </a></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- 新增/修改功能 -->
			<div class="border border-primary shadow bg-light">
				<div class="row mb-2 m-0">
					<div class="col-md-5 p-0">
						<a class="btn btn-sm btn-success" data-toggle="collapse" href="#collapseAdded" role="button" aria-expanded="true" aria-controls="collapseAdded"> 新增/另存/修改/刪除 功能 : </a>
					</div>
				</div>
				<form onsubmit="return templateBody.send_added_or_update_save();">
					<div class="collapse show" id="collapseAdded">
						<!-- 新增 或 修改(分辨) -->
						<div class="h5">
							<div class="row p-0 m-0 mb-2 col-md-4 text-left ">
								<div class="col-md-3">狀態 :</div>
								<div class="col-md-9" id="a_u_type" style="font-size: 25px; color: red;">新增資料</div>
							</div>
							<div class="row p-0 m-0 mb-2">
								<div class="col-md-2">
									<div class="row m-0 text-left">
										<div class="col-md-4 p-0">ID:</div>
										<div class="col-md-8 p-0" id="a_u_id">0</div>
									</div>
								</div>
								<div class="col-md-3">
									<div class="row m-0 text-left">
										<div class="col-md-4 p-0">產品型號:</div>
										<div class="col-md-8 p-0" id="">
											<input class="col-md-12" type="text" id="a_u_model" placeholder="Ex:型號123456" required autofocus />
										</div>
									</div>
								</div>
								<div class="col-md-3">
									<div class="row m-0 text-left">
										<div class="col-md-8 p-0">主機板(硬體)-版本:</div>
										<div class="col-md-4 p-0" id="">
											<input class="col-md-12" type="text" id="a_u_version_motherboard" placeholder="Ex:R1.3" required />
										</div>
									</div>
								</div>
								<div class="col-md-4">
									<div class="row m-0 text-left">
										<div class="col-md-4 pr-0">BOM料號:</div>
										<div class="col-md-8 p-0" id="">
											<input class="col-md-12" type="text" id="a_u_bom_number" placeholder="Ex:A512-9487945-08449" required />
										</div>
									</div>
								</div>
							</div>
							<div class="row p-0 m-0 mb-2">
								<div class="col-md-2">
									<div class="row m-0 text-left mb-2">
										<div class="col-md-4 p-0">啟用 :</div>
										<div class="col-md-8 p-0" id="">
											<input class="col-md-12" type="text" id="a_u_useful" placeholder="1=開 2=關" value="1" required />
										</div>
									</div>
									<div class="row m-0 text-left align-items-center">
										<div class="col-md-4 p-0 ">類型 :</div>
										<div class="col-md-8 p-0" id="">
											<select class=" col-md-12 custom-select" id="a_u_kind" id="inlineFormCustomSelect">
												<option value="0" selected>技轉中</option>
												<option value="1">可量產</option>
											</select>
										</div>
										<div class="col-md-4 p-0" style="font-size: 20px; color: red;">限制 :</div>
										<div class="col-md-8 p-0 mt-2" id="" style="font-size: 18px; color: red;">
											[可裝配 <b id="needUseNb">42</b> 項]<br>[不裝配 <b id="notUseNb">28</b> 項]
										</div>
									</div>
								</div>
								<div class="col-md-10">
									<div class="row m-0 text-left">
										<div class="col-md-1 p-0">說明備註:</div>
										<div class="col-md-11 p-0 pl-2" id="">
											<textarea class="col-md-12" id="a_u_note" placeholder="備註" rows="4" cols="50" /></textarea>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="dropdown-divider" style="border-top: 1px solid green;"></div>
						<!-- 新增 或 修改 或 刪除(內容) -->
						<div class="mb-3 mt-3">
							<!-- 顯示內容 -->
							<div class="">
								<table class="table table-sm table-hover table-striped table-bordered table-responsive">
									<thead>
										<tr id="group_thead" class="bg-primary h5">
											<th scope="col" style="min-width: 90px;">功能</th>
											<th scope="col" style="min-width: 60px;">ID</th>
											<th scope="col" style="min-width: 60px;">組ID</th>
											<th scope="col" style="min-width: 150px;">項目組</th>
											<th scope="col" style="min-width: 60px;">項目</th>
											<th scope="col" style="min-width: 300px;">項目名稱</th>
											<th scope="col" style="min-width: 80px;">數量</th>
											<th scope="col" style="min-width: 70px;">排序</th>
											<th scope="col" style="min-width: 150px; width: 100%;">說明備註</th>
										</tr>
									</thead>
									<tbody id="group_tbody">
										<tr class="t_p_row0">
											<td class="s_type_added"><button name="" id="a_item" type="button" class="btn btn-success btn-sm btn-block a_p_submit">添加</button></td>
											<td id="group_id_0">0</td>
											<td id="item_group_id_0"></td>
											<td class="s_type_added"><select name="0" id="a_g_item_0" class="a_g_item md-12" disabled="disabled"></select></td>
											<td id="item_id_0"></td>
											<td class="s_type_added"><select name="0" id="a_i_item_0" class="md-12 a_i_item" disabled="disabled">
													<option value="">請選擇</option>
											</select></td>
											<td><input class="col-md-12" type="text" id="group_number_0" placeholder="Ex:1" value="0" required disabled="disabled" /></td>
											<td id="a_i_order_0"></td>
											<td id="a_i_note_0"></td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
						<div class="row mb-3">
							<div class="col-md-4"></div>
							<div class="col-md-2">
								<div class="">
									<button id="a_u_submit" class="btn btn-primary btn-block" type="submit">存入資料</button>
								</div>
							</div>
							<div class="col-md-2">
								<div class="">
									<button id="a_c_submit" class="btn btn-warning btn-block" type="button">預設內容</button>
								</div>
							</div>
							<div class="col-md-4"></div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
    console.log("bom_product_body");
    templateBody = new Vue({
        el: "#bom_product_body",
        data: {
            l_search_thead: "", //鎖定查詢
            search_list: "",
            group_list: "",
            item_list: "",
            item_nb_max: 1, //最大ID數
            needUseNb : 42,//限制 可裝配
            notUseNb : 28,//限制 不裝配
            def_choose : false,
            //分頁功能
            page_max:100,//當前本批 筆數
            page_max_total:100,//最大總數
            page_batch:0,//第幾批
            page_batch_total:100,//每批間格值
            page_every:10,//當前每頁筆數
            page_stay:1,//當前頁數
        },
        created: function () {
            //初始化
            console.log(main.contentData.templateInfo.body);
            this.group_list = main.contentData.templateInfo.body["group_list"];
            this.item_list = main.contentData.templateInfo.body["item_list"];
            this.search_list = main.contentData.templateInfo.body["list"];
			var f_n = 0;
			var create_u = 3;
			var modfiy_u = 5;
            //t_choose
            var min_width = 100;
            for (var i = 0; i < this.search_list[0].length; i++) {
                var choose_check = '[<div class="text-left form-check">';
                choose_check += '<input class="form-check-input" type="checkbox" value="" id="s_' + i + '" checked>';
                choose_check += '<label class="form-check-label" for="s_' + i + '">' + this.search_list[0][i] + "</label>";
                choose_check += "</div>]";
                $("#search_choose").append(choose_check);
            }
            //t_header
            for (var i = 0; i < this.search_list[0].length; i++) {
                if (  i == 2|| i == 3 || i == 5 || i == 7 || i == 9) {
                    min_width = 180;
                }
                if ( i == 1  ||i == 6) {
                    min_width = 150;
                }
                $("#search_thead").append('<th style="min-width: ' + min_width + 'px;" class="s_' + i + '" scope="col">' + this.search_list[0][i] + "</th>");
                min_width = 80;
            }
            //t_body
            this.search_update();
            //t_body_group
            this.group_choose();
            //建立 選項
            this.group_item_choose("s_g_item", -1);
            this.group_item_choose("a_g_item_0", 0);

            //動態監聽顯示Table 物件 查看開關
            $(document).on("click", "#search_choose input", function (event) {
                templateBody.search_choose(event);
            });
            //查詢監聽
            $(document).on("click", "#s_submit", function (event) {
                templateBody.change_page_init();
                templateBody.send_search("R");
            });
            //清除修改(預設)
            $(document).on("click", "#a_c_submit", function (event) {
                templateBody.rm_added(true);
                templateBody.check_nb();
                setTimeout(function(){
                  	 $("html,body").animate({ scrollTop: 1000 }, 'slow'); 
                  }, 500);
            });
            //切換項目 監聽
            $(document).on("change", "#s_g_item", function (event) {
                templateBody.item_choose(event, -1);
            });
            //下方 切換項目 監聽
            $(document).on("change", ".a_g_item", function (event) {
                templateBody.item_choose(event, event.target.attributes.name.value);
            });
            //切換子項目 監聽
            $(document).on("change", ".a_i_item", function (event) {
                templateBody.item_one_choose(event,templateBody.def_choose);
            });
            //新增監聽
            $(document).on("click", "#a_item", function (event) {
                templateBody.added_item("");
                templateBody.check_nb();
            });
            // 條件清除
            $(document).on("click", "#s_c_submit", function (event) {
                templateBody.rm_select();
            });
            //條件鎖定
            $(document).on("click", "#s_l_submit", function (event) {
                templateBody.lk_select();
            });
            //監聽異動
             $(document).on("change", ".item_nbs", function (event) {
            	 templateBody.check_nb();
            });
           
        },
        methods: {
            search_choose: function (event) {
                console.log(event.target.checked);
                if (!event.target.checked) {
                    $("#search_thead ." + event.target.id).hide();
                    $("#search_tbody ." + event.target.id).hide();
                } else {
                    $("#search_thead ." + event.target.id).show();
                    $("#search_tbody ." + event.target.id).show();
                }
            },
            //查詢更新
            search_update: function () {
                //刷新計數器
                for (var i = 0; i < this.group_list.length; i++) {
                    if (this.item_nb_max <= this.group_list[i][4]) {
                        this.item_nb_max = this.group_list[i][4] + 1;
                    }
                }
                $("#group_id_0").text(this.item_nb_max);
                $("#a_item").attr("name", this.item_nb_max);

                $("#search_tbody").empty();
              	//頁數-刷新
                this.change_page_update();
                
                //t_body
                for (var i = 1; i < this.search_list.length; i++) {
                	//頁數-每頁顯示(不再顯示範圍內則隱藏)
                	var page_group = this.change_page_btn(i);
                	
                    //功能
                    var s_list = this.search_list[i][0];

                    var na_submit = '<div class="md-6">';
                    na_submit += '<button user_id="' + s_list + '" class="btn btn-info btn-sm btn-block na_submit">';
                    na_submit += "另</button></div>";
                    
                    var a_submit = '<div class="md-6 ml-1">';
                    a_submit += '<button user_id="' + s_list + '" class="btn btn-warning btn-sm btn-block a_submit">';
                    a_submit += "改</button></div>";

                    var d_submit = '<div class="md-6 ml-1">';
                    d_submit += '<button user_id="' + s_list + '" class="btn btn-danger btn-sm btn-block d_submit">';
                    d_submit += "刪</button></div>";

                    $("#search_tbody").append('<tr class= "page_all t_row' + s_list + ' '+page_group+'" style="white-space: nowrap;"><th class="ml-0 col-md-12 row">'+na_submit + a_submit + d_submit + '</th></tr>');
                    //計數量
                    $("#search_tbody .t_row" +s_list).append("<td >" + i + "</td>");

                    for (var j = 0; j < this.search_list[i].length; j++) {
                        $("#search_tbody .t_row" + s_list).append("<td class=s_" + j + ">" + this.search_list[i][j] + "</td>");
                    }
                }
                //另存監聽
                $(document).off("click", ".na_submit");
                $(document).on("click", ".na_submit", function (event) {
                    templateBody.choose_update("另存資料", event);
                    templateBody.check_nb();
                    setTimeout(function(){
                   	 $("html,body").animate({ scrollTop: 1000 }, 'slow'); 
                   }, 500);
                });
                //修改監聽
                $(document).off("click", ".a_submit");
                $(document).on("click", ".a_submit", function (event) {
                    templateBody.choose_update("修改資料", event);
                    templateBody.check_nb();
                    setTimeout(function(){
                   	 $("html,body").animate({ scrollTop: 1000 }, 'slow'); 
                   }, 500);
                });
                //刪除監聽
                $(document).off("click", ".d_submit");
                $(document).on("click", ".d_submit", function (event) {
                    templateBody.choose_delete(event);
                    setTimeout(function(){
                      	 $("html,body").animate({ scrollTop: 1000 }, 'slow'); 
                      }, 500);
                });
            },
            //選擇群組-並建立監聽
            group_choose: function () {
                var group = "";
                $("#a_u_group_name select").empty();
                group += '<option value="">請選擇</option>';
                $.each(this.search_group, function (index, val) {
                    group += "<option value=" + val + ">" + index + "</option>";
                });
                $("#a_u_group_name select").append(group);

                $(document).on("change", "#a_u_group_name select", function (event) {
                    $("#a_u_group_id").text(event.target.value);
                });
            },
            //選擇項目
            item_choose: function (event, who) {
                var s_i_item = "";
                var s_body = "";
                var s_header = "";
                for (var i = 0; i < templateBody.item_list.length; i++) {
                    if (templateBody.item_list[i][0] == event.target.value) {
                        var value_i = "";
                        //項目
                        if (templateBody.item_list[i][2] == 1) {
                            value_i += "--| ";
                            //第 6 格開始是 資料參數
                            for (var j = 6; j < templateBody.item_list[i].length - 1; j++) {
                                value_i += templateBody.item_list[i][j] + " | ";
                            }
                            value_i += "--";
                            s_header += "<option value='' >" + value_i + "</option>";
                            //同步 排序
                            $("#a_i_order_" + who).text(templateBody.item_list[i][4]);
                            //同步 說明
                             $("#a_i_note_" + who).text(templateBody.item_list[i][5]);
                            
                        } else {
                        	//第 6 格開始是 資料參數
                            value_i += "| ";
                            for (var j = 6; j < templateBody.item_list[i].length - 1; j++) {
                                value_i += templateBody.item_list[i][j] + " | ";
                            }
                            s_body += "<option value='" + templateBody.item_list[i][2] + "'>" + value_i + "</option>";
                        }
                    }
                }
                s_i_item += s_header + s_body;
                //沒選擇的話
                if (s_i_item == "") {
                    s_i_item = "<option value=''>請選擇</option>";
                }
                //如果是 "新增選擇" 的話 a_i_item_
                if (who > -1) {
                    $("#item_id_" + who).text("");
                    $("#item_group_id_" + who).text(event.target.value);
                    $("#a_i_item_" + who).empty();
                    $("#a_i_item_" + who).append(s_i_item);
                } else {
                    //如果是 "查詢選擇" 的話 s_i_item
                    $("#s_i_item").empty();
                    $("#s_i_item").append(s_i_item);
                }
            },
            //選擇 群組-項目
            group_item_choose: function (id, def) {
                //s_choose s_g_item
                var s_g_item = "<option value=''>請選擇</option>";
                var group_name = "";
                for (var i = 0; i < this.item_list.length; i++) {
                    if (group_name != this.item_list[i][1]) {
                        s_g_item += "<option value='" + this.item_list[i][0] + "'>" + this.item_list[i][1] + "</option>"; //群組
                        group_name = this.item_list[i][1];
                    }
                }
                $("#" + id).empty();
                $("#" + id).append(s_g_item);
            },
            //更新 項目ID
            item_one_choose: function (event,def_choose) {
                $("#item_id_" + event.target.attributes.name.value).text(event.target.value);
            	//數量變化
                var qty_id = event.currentTarget.id.replaceAll('a_i_item','group_number');
                var item_c =$("#"+event.currentTarget.id).children("option:selected");
                if(def_choose){
	    			$("#"+qty_id).val(1);                	
                }
            	if(item_c.text().indexOf("無")>0 ||item_c.text().indexOf("No")>0||item_c.val()==""){
            		$("#"+qty_id).val(0);
    			}
            	templateBody.check_nb();
            },
            //清除新增/修該內容
            rm_added: function (def) {
            	$("#a_g_item_0").val("").trigger("change");
                $("#group_id_0").text(this.item_nb_max);
                $("#a_item").attr("name", this.item_nb_max);
                $("#a_u_type").text("新增資料");
                $("#a_u_id").text(0);
                $("#a_u_model").val("");
                
                $("#a_u_bom_number").val("");
                $("#a_u_version_motherboard").val("");
                $("#a_u_useful").val("1");
                $("#a_u_note").val("");

                $("#group_number_0").val(0);

                var check = $("#group_tbody .re_choose");
                if (check !== null) {
                    $("#group_tbody .re_choose").remove();
                }
                this.choose_disabled(false);
                if (def) {
                    this.added_item_list();
                }
                //鎖定
                $(".s_type_item_list select").attr("disabled", "disabled");
            },
            //清除選擇
            rm_select: function () {
                $("#s_l_list").empty();
                $("#s_l_list").append('<div class="text-left mb-2 mt-2">條件清單:</div>');
                $("#s_model").val("");
                $("#s_bom_number").val("");
                $("#s_g_item").val("").trigger("change");
            },
            //鎖定~
            lk_select: function () {
                var lk = "{";
                lk += "'g_item':'" + $("#s_g_item").val() + "',";
                lk += "'i_item':'" + $("#s_i_item").val() + "',";
                lk += "'p_model':'" + $("#s_model").val() + "',";
                lk += "'p_bom_number':'" + $("#s_bom_number").val() + "'}";

                $("#s_l_list").append('<div class="text-left mb-2 mt-2">' + lk + "</div>");
              //清除選擇
				$("#s_model").val("");
				$("#s_bom_number").val("");
				$("#s_g_item").val("").trigger("change");
            },
            //檢查數量 可配備42項目/部裝配28項目
            check_nb: function(){
            	var notUse = 0;
            	var needUse = 0;
            	$(".item_nbs");
            	for (var i = 0; i < $(".item_nbs").length; i++) {
            		if($(".item_nbs")[i].value>0){
            			needUse+=1;
            		}else{
            			notUse+=1;            			
            		}
				}
            	$("#notUseNb").text(this.notUseNb-notUse);
            	$("#needUseNb").text(this.needUseNb-needUse);
            },

            //新增子項目
            added_item: function (def_item) {
                var add_id = $(".t_p_row0 #group_id_0").text();
                var group_tbody = "";
                group_tbody += '<tr class="t_p_row' + add_id + ' re_choose">';
                group_tbody += '<td class="s_type_delete">';
                group_tbody += "<button id=" + add_id + '  type="button" class="btn btn-danger btn-sm btn-block d_item">移除</button>';
                group_tbody += "</td>";
                group_tbody += '<td id="group_id_' + add_id + '">' + add_id + "</td>";
                group_tbody += '<td id="item_group_id_' + add_id + '"></td>';
                group_tbody += '<td class="s_type_item_list">';
                group_tbody += '<select name="' + add_id + '" id="a_g_item_' + add_id + '" class="a_g_item md-12" required>';
                group_tbody += "</select></td>";
                group_tbody += '<td id="item_id_' + add_id + '"></td>';
                group_tbody += '<td class="s_type_item_one">';
                group_tbody += '<select name="' + add_id + '" id="a_i_item_' + add_id + '" class="md-12 a_i_item" required>';
                group_tbody += '<option value="">請選擇</option>';
                group_tbody += "</select></td>";
                group_tbody += '<td><input class="col-md-12 pr-0 item_nbs" type="number" id="group_number_' + add_id + '" placeholder="Ex:1" required value="1" /></td>';
                group_tbody += '<td id="a_i_order_' + add_id + '"></td>';
                group_tbody += '<td id="a_i_note_' + add_id + '"></td>';
                $(".t_p_row0").after(group_tbody);
                this.group_item_choose("a_g_item_" + add_id, 0);
                //同步帶入
                $("#a_i_order_" + add_id).text(0);

                //下方 切換項目 監聽
                /*$(document).off("change", ".a_g_item");
                $(document).on("change", ".a_g_item", function (event) {
                    templateBody.item_choose(event, event.target.attributes.name.value);
                });*/
                
                //切換子項目 監聽
               /* $(document).off("change", ".a_i_item");
                $(document).on("change", ".a_i_item", function (event) {
                    templateBody.item_one_choose(event);
                    
                });*/
                //移除監聽
               	$(document).off("click", ".d_item");
                $(document).on("click", ".d_item", function (event) {
                    templateBody.re_item(event);
                   
                });
                //設定預設參數
                $("#group_number_" + add_id).val($(".t_p_row0 #group_number_0").val());
                if (def_item != "") {
                    $("#group_tbody #a_g_item_" + add_id)
                        .val(def_item)
                        .trigger("change");
                } else {
                    $("#group_tbody #a_g_item_" + add_id)
                        .val($(".t_p_row0 #a_g_item_0").val())
                        .trigger("change");
                }
                $("#group_tbody #a_i_item_" + add_id)
                    .val($(".t_p_row0 #a_i_item_0").val())
                    .trigger("change");

                //添加+1
                $(".t_p_row0 #group_id_0").text(parseInt(add_id) + 1);
                $(".t_p_row0 #a_item").attr("name", parseInt(add_id) + 1);
                
            },
            //新曾子項目 -預設+鎖定
            added_item_list: function () {
                var list = this.item_list;
                for (var i = 0; i < list.length; i++) {
                    if (list[i][2] == 1) {
                        this.added_item(list[i][0]);
                    }
                }
                
            },
            //選擇  修改(另存)
            choose_update: function (a_u_type, event) {
            	templateBody.def_choose = false;
                $("#group_id_0").text(this.item_nb_max);
                $("#a_item").attr("name", this.item_nb_max);

                $("#a_u_type").text(a_u_type);
                var check = $("#group_tbody .re_choose");
                if (check !== null) {
                    $("#group_tbody .re_choose").remove();
                }
                
                var id = event.target.attributes.user_id.value;
                $("#a_u_id").text($(".t_row" + id + " .s_0")[0].innerText);
                $("#a_u_model").val($(".t_row" + id + " .s_1")[0].innerText);
                $("#a_u_version_motherboard").val($(".t_row" + id + " .s_2")[0].innerText);
               	$("#a_u_bom_number").val($(".t_row" + id + " .s_3")[0].innerText);
				if(a_u_type=="另存資料"){
					$("#a_u_bom_number").val("");
                }
                $("#a_u_note").val($(".t_row" + id + " .s_4")[0].innerText);
                $("#a_u_useful").val($(".t_row" + id + " .s_5")[0].innerText);
                $("#a_u_kind").val($(".t_row" + id + " .s_6")[0].innerText).change();
                
                var group_tbody = "";
               
                for (var i = 0; i < this.group_list.length; i++) {
                    if (id == this.group_list[i][5] && this.group_list[i][6] != 1) {
                        group_tbody = "";
                        group_tbody += '<tr class="t_p_row' + this.group_list[i][4] + ' re_choose">';
                        group_tbody += '<td class="s_type_delete">';
                        group_tbody += "<button id=" + this.group_list[i][4] + '  type="button" class="btn btn-danger btn-sm btn-block d_item">移除</button>';
                        group_tbody += "</td>";
                        group_tbody += '<td id="group_id_' + this.group_list[i][4] + '">' + this.group_list[i][4] + "</td>";
                        group_tbody += '<td id="item_group_id_' + this.group_list[i][4] + '"></td>';
                        group_tbody += '<td class="s_type_item_list">';
                        group_tbody += '<select name="' + this.group_list[i][4] + '" id="a_g_item_' + this.group_list[i][4] + '" class="a_g_item md-12" required>';
                        group_tbody += "</select></td>";
                        group_tbody += '<td id="item_id_' + this.group_list[i][4] + '"></td>';
                        group_tbody += '<td class="s_type_item_one">';
                        group_tbody += '<select name="' + this.group_list[i][4] + '" id="a_i_item_' + this.group_list[i][4] + '" class="md-12 a_i_item" required>';
                        group_tbody += '<option value="">請選擇</option>';
                        group_tbody += "</select></td>";
                        group_tbody += '<td><input class="col-md-12 item_nbs pr-0" type="number" id="group_number_' + this.group_list[i][4] + '" placeholder="Ex:1" required value="0" /></td>';
                        group_tbody += '<td id="a_i_order_' + this.group_list[i][4] + '"></td>';
                        group_tbody += '<td id="a_i_note_' + this.group_list[i][4] + '"></td>';
                        $("#group_tbody").append(group_tbody);
                        this.group_item_choose("a_g_item_" + this.group_list[i][4], 0);
                    }
                }
                //下方 切換項目 監聽
               /* $(document).off("change", ".a_g_item");
                $(document).on("change", ".a_g_item", function (event) {
                    templateBody.item_choose(event, event.target.attributes.name.value);
                });
                //切換子項目 監聽
                $(document).off("change", ".a_i_item");
                $(document).on("change", ".a_i_item", function (event) {
                    templateBody.item_one_choose(event,templateBody.def_choose);
                });*/
                //移除監聽
                $(document).off("click", ".d_item");
                $(document).on("click", ".d_item", function (event) {
                    templateBody.re_item(event);
                });
                //設定預設參數
                
                for (var i = 0; i < this.group_list.length; i++) {
                    if (id == this.group_list[i][5]) {
                        $("#group_tbody #group_number_" + this.group_list[i][4]).val(this.group_list[i][8]);
                        $("#group_tbody #a_i_order_" + this.group_list[i][4]).val(this.group_list[i][9]);
                        $("#group_tbody #a_g_item_" + this.group_list[i][4])
                            .val(this.group_list[i][7])
                            .trigger("change");
                        $("#group_tbody #a_i_item_" + this.group_list[i][4])
                            .val(this.group_list[i][6])
                            .trigger("change");
                    }
                }
                this.choose_disabled(false);
                //鎖定
                $("#group_number_0").attr("disabled","disabled");
                $("#a_i_item_0").attr("disabled","disabled");
                $("#a_g_item_0").attr("disabled","disabled");
                templateBody.def_choose = true;
                
            },
            //選擇 刪除
            choose_delete: function (event) {
                var id = event.target.attributes.user_id.value;
                var a_u_type = "移除資料";
                $("#a_u_type").text(a_u_type);

                this.choose_update(a_u_type, event);
                this.choose_disabled("disabled");
            
            },
            //移除項目
            re_item: function (event) {
                console.log(event.target.id);
                $(".t_p_row" + event.target.id).remove();
                templateBody.check_nb();
            },
            //鎖定資料
            choose_disabled: function (disabled) {
                $("#a_u_model").attr("disabled", disabled);
                
                $("#a_u_bom_number").attr("disabled", disabled);
              
                $("#a_u_version_motherboard").attr("disabled", disabled);
                $("#a_u_useful").attr("disabled", disabled);
                $("#a_u_note").attr("disabled", disabled);
                $("#a_u_kind").attr("disabled", disabled);
                
                $("#group_tbody select").attr("disabled", disabled);
                $("#group_tbody button").attr("disabled", disabled);
                $("#group_tbody input").attr("disabled", disabled);
            },
            //頁數-初始化(新增 or 修改 or 刪除 or 條件 要重製)
            change_page_init:function(){
			
              //active 更換為第一格
              	var a = "active";
              	var d = "disabled";
              	$(".page-item").removeClass(a);
              	$(".page-item").removeClass(d);
              	for (var re_page = 1; re_page <= 10; re_page++) {
					var now_page = re_page+(this.page_batch*10);
					//如果就在第一頁 不需更換
					if(!$("#page-items .p"+now_page).hasClass("p"+re_page)){
						$("#page-items .p"+now_page).addClass("p"+re_page);
						$("#page-items .p"+re_page).removeClass("p"+now_page);
						$("#page-items .p"+re_page+" a").text(re_page);
						$("#page-items .p"+re_page+" a").attr("id","p"+re_page);
					}
					if(re_page==1){
						$("#page-items .p"+re_page).addClass(a);
					}					
           		}
            	//分頁功能
                this.page_max=100;//當前本批 筆數
                this.page_max_total=100;//最大總數
                this.page_batch=0;//第幾批
                this.page_batch_total=100;//每批間格值
                this.page_every=10;//當前每頁筆數
                this.page_stay=1;//當前頁數
              	
            },
            //頁數-刷新
            change_page_update :function(){
            	 //頁數-取得當前最大筆數 && 頁數
                this.page_max = this.search_list.length;
                $(".p_n").removeClass("disabled");
                if(this.page_max<=this.page_max_total){
                	$(".p_n").addClass("disabled");
                }
                $(".p_p").removeClass("disabled");
                if(this.page_batch<1){
                	$(".p_p").addClass("disabled");
                }
              	//頁數-隱藏多於頁數
                $(".p_nb").addClass("disabled");
              	
              	
            },
            //頁數-換頁按鈕建置(頁數-每頁顯示)
            change_page_btn:function(i){
            	var d_none = "";
            	if(i>(this.page_every*this.page_stay)){
            		d_none = "d-none";
				}
            	//頁數-(個位數)+(十位數)
            	var page_group="pg_"+(Math.floor((i-1)/this.page_every)+1+(this.page_batch*10));
            	var page_nb = "p"+(Math.floor((i-1)/this.page_every)+1+(this.page_batch*10));
            	$("."+page_nb).removeClass("disabled");
            	return page_group+" "+d_none;
            },
            //頁數-換頁查詢
            change_page:function (event){
            	var d = "disabled";
            	var d_n  = "d-none";
            	var a = "active";
            	var pg = "pg_";
            	console.log("page btn is:"+event.text);
            	//選定頁數
            	if(event.id!="p_p" && event.id!="p_n"){
	            	$(".page-item").removeClass(a);
	            	$("."+event.id).addClass(a);
	            	
	            	$(".page_all").addClass(d_n);
	            	$("."+pg+event.text).removeClass(d_n);
	            	
            	}else if(event.id=="p_p"){//上10頁(批數 要大於1)
            		if(this.page_batch>0){
	            		//換上一批次 頁數
						$(".page-item").removeClass(a);
						
	            		for (var i = 1; i <= 10; i++) {
							var now_page = i+(this.page_batch*10);
							var previous_page = i+((this.page_batch)*10)-10;
							$(".p"+now_page).addClass("p"+previous_page);
							$(".p"+previous_page).removeClass("p"+now_page);
							$(".p"+previous_page+" a").text(previous_page);
							$(".p"+previous_page+" a").attr("id","p"+previous_page);
							if(i==1){
								$(".p"+previous_page).addClass(a);
							}
	            		}						
	            		this.page_batch-=1;
	            		this.send_search("R_P");
					}
            	}else if(event.id=="p_n"){//下10頁(必須滿100筆最大量 )

            		this.page_batch+=1;
		         	this.send_search("R_N");            		
            	}
            	
            	return false;
            },
            change_page_next:function(){
            	var d = "disabled";
            	var d_n  = "d-none";
            	var a = "active";
            	var pg = "pg_";
            	if(this.page_max>this.page_max_total){
            	//換下一批次 頁數
				$(".page-item").removeClass(a);
	           		for (var i = 1; i <= 10; i++) {
						var now_page = i+((this.page_batch-1)*10);
						var next_page = i+((this.page_batch)*10);
						$(".p"+now_page).addClass("p"+next_page);
						$(".p"+next_page).removeClass("p"+now_page);
						$(".p"+next_page+" a").text(next_page);
						$(".p"+next_page+" a").attr("id","p"+next_page);
						if(i==1){
							$(".p"+next_page).addClass(a);
						}
	           		}
	           		//this.page_batch+=1;
            	}
            },
            //傳送 新增 or 修改 or 刪除 or 另存
            send_added_or_update_save: function () {
            	if ($('#needUseNb').text()<0 || $('#notUseNb').text()<0) {
					main.alertshow(true, "[可裝配 or 不裝配]項目數量異常 ,請再次檢查清楚!!");
					return false;
				}
            	//移動
            	 setTimeout(function(){
                  	 $("html,body").animate({ scrollTop: 350 }, 'slow'); 
                  }, 500);
            	
                var content = new Object();
                var product = new Object(); //產品資料
                var group_item = []; //group 內資料
                var group_one = [];
              	//頁數-重製分頁
            	this.change_page_init();
              	
                //BOM 產品清單
                product.id = $("#a_u_id").text();
                product.product_model = $("#a_u_model").val();
               
                product.version_motherboard = $("#a_u_version_motherboard").val();
                product.bom_number = $("#a_u_bom_number").val();
                product.note = $("#a_u_note").val();
                product.useful = $("#a_u_useful").val();
                product.kind = $("#a_u_kind").val(); 

                content.product = product;
                //BOM群組 需要內容

                var id = 0;
                for (var i = 1; i < $("#group_tbody tr").length; i++) {
                    id = $("#group_tbody tr")[i].children[1].textContent;
                    group_one = [];
                    group_one.push(id);
                    group_one.push(product.id);
                    group_one.push($("#item_id_" + id).text());
                    group_one.push($("#item_group_id_" + id).text());
                    group_one.push($("#group_number_" + id).val());
                    group_item.push(group_one);
                }
                content.group_item = group_item;
                console.log(content);
                var action = "C";
                var url = "./added_bom_product.do";
                var order = "search_update"; //指令
                if ($("#a_u_type").text() == "修改資料") {
                    action = "U";
                    url = "./update_bom_product.do";
                }
                if ($("#a_u_type").text() == "移除資料") {
                    action = "D";
                    url = "./delete_bom_product.do";
                }
				//查詢
                var search_list = [];
                for (var i = 1; i < $("#s_l_list div").length; i++) {
                    search_list.push($("#s_l_list div")[i].innerText);
                }
                content.search_list = search_list;
                content.page_nb = this.page_batch*this.page_batch_total;//批次(起始數)
                content.page_total = this.page_batch_total;//(每次要的最大數量)
                
                var data = JSON.stringify({
                    data: {
                        datetime: "",
                        action: action,
                        whoami: main.loginData.account,
                        cellBackName: "bodyAfter",
                        cellBackOrder: order,
                        content: content,
                    },
                });
             
                main.ajaxSend(url, data);
              	
                return false; //防止真傳送
            },
            //傳送 查詢
            send_search: function (action) {
                var content = new Object();
                var search_list = [];

                for (var i = 1; i < $("#s_l_list div").length; i++) {
                    search_list.push($("#s_l_list div")[i].innerText);
                }

                content.search_list = search_list;
                content.page_nb = this.page_batch*this.page_batch_total;//批次(起始數)
                content.page_total = this.page_batch_total;//(每次要的最大數量)
                var url = "./bom_product.do";
                var order = "search_update"; //指令

                var data = JSON.stringify({
                    data: {
                        datetime: "",
                        action: action,
                        whoami: main.loginData.account,
                        cellBackName: "bodyAfter",
                        cellBackOrder: order,
                        content: content,
                    },
                });
                main.ajaxSend(url, data);
            },
            //Rsp-回傳值-指令
            bodyAfter: function (event) {
                console.log("to index success");
                switch (event.r_cellBackOrder) {
                    case "search_update":
                     
                        if (event.r_content.templateInfo.body["list"] != null && event.r_content.templateInfo.body["list"] != "") {
                       		 //刷新資料
                            this.group_list =  main.contentData.templateInfo.body["group_list"];
                            this.item_list =   main.contentData.templateInfo.body["item_list"];
                            this.search_list = main.contentData.templateInfo.body["list"];
                           
                            //如果是下一頁
                            if(event.r_action=="R_N"){
 								this.change_page_next();
                            }
                            this.search_update();
                            this.rm_added(false);
                        }else{
                        	//沒查到資料時
                        	this.page_batch-=1;
                        }
                        
                        break;
                    case "update_body_nav":
                        break;
                }
            },
        },
        //移除監聽事件
        beforeDestroy: function () {
            console.log("to beforeDestroy event");
            $(document).off("click", "#a_u_group_name select");
            $(document).off("click", "#search_choose input");
            $(document).off("click", "#s_submit");
            $(document).off("click", "#a_c_submit");
            $(document).off("click", ".a_submit");
            $(document).off("click", ".d_submit");

            $(document).off("click", "#a_u_submit");
            $(document).off("click", "#s_l_submit");
            $(document).off("click", "#s_c_submit");
            $(document).off("change", "#s_g_item");
            $(document).off("change", ".a_g_item");
            $(document).off("click", "#a_item");
            $(document).off("click", ".a_i_item");
            $(document).off("change", ".item_nbs");
            
        },
    });
</script>
